# ==================== TRAEFIK INGRESSROUTE ====================
# Main routing configuration for GovConnect services
# Domain: govconnect.my.id (Dashboard), api.govconnect.my.id (API)

---
# ==================== DASHBOARD INGRESSROUTE ====================
# Dashboard at root domain: govconnect.my.id
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: govconnect-dashboard
  namespace: govconnect
  labels:
    app.kubernetes.io/name: govconnect
    app.kubernetes.io/component: ingress
spec:
  entryPoints:
    - web
    - websecure
  routes:
    # Dashboard UI - All paths
    - match: Host(`govconnect.my.id`)
      kind: Rule
      priority: 1
      middlewares:
        - name: security-headers
        - name: compress
        - name: rate-limit-public
      services:
        - name: dashboard
          port: 3000
  # TLS Configuration - uncomment after cert-manager setup
  # tls:
  #   secretName: govconnect-tls

---
# ==================== API GATEWAY INGRESSROUTE ====================
# API at subdomain: api.govconnect.my.id
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: govconnect-api
  namespace: govconnect
  labels:
    app.kubernetes.io/name: govconnect
    app.kubernetes.io/component: ingress
spec:
  entryPoints:
    - web
    - websecure
  routes:
    # ==================== WEBHOOK (Highest Priority) ====================
    # WhatsApp Webhook - public endpoint
    - match: Host(`api.govconnect.my.id`) && PathPrefix(`/webhook`)
      kind: Rule
      priority: 100
      middlewares:
        - name: rate-limit-public
        - name: cors-webhook
        - name: security-headers
      services:
        - name: channel-service
          port: 3001

    # ==================== CHANNEL SERVICE ====================
    - match: Host(`api.govconnect.my.id`) && PathPrefix(`/api/channel`)
      kind: Rule
      priority: 50
      middlewares:
        - name: rate-limit-internal
        - name: cors-dashboard
        - name: security-headers
        - name: strip-api-channel
        - name: retry-middleware
      services:
        - name: channel-service
          port: 3001

    # Media uploads (no strip prefix)
    - match: Host(`api.govconnect.my.id`) && PathPrefix(`/uploads`)
      kind: Rule
      priority: 50
      middlewares:
        - name: security-headers
        - name: compress
      services:
        - name: channel-service
          port: 3001

    # ==================== CASE SERVICE ====================
    - match: Host(`api.govconnect.my.id`) && PathPrefix(`/api/cases`)
      kind: Rule
      priority: 50
      middlewares:
        - name: rate-limit-internal
        - name: cors-dashboard
        - name: security-headers
        - name: strip-api-cases
        - name: retry-middleware
      services:
        - name: case-service
          port: 3003

    # Legacy endpoints (laporan, tiket, statistics)
    - match: Host(`api.govconnect.my.id`) && (PathPrefix(`/laporan`) || PathPrefix(`/tiket`) || PathPrefix(`/statistics`))
      kind: Rule
      priority: 40
      middlewares:
        - name: rate-limit-internal
        - name: cors-dashboard
        - name: security-headers
        - name: retry-middleware
      services:
        - name: case-service
          port: 3003

    # ==================== AI SERVICE ====================
    - match: Host(`api.govconnect.my.id`) && PathPrefix(`/api/ai`)
      kind: Rule
      priority: 50
      middlewares:
        - name: rate-limit-ai
        - name: cors-dashboard
        - name: security-headers
        - name: strip-api-ai
        - name: circuit-breaker
      services:
        - name: ai-service
          port: 3002

    # ==================== NOTIFICATION SERVICE ====================
    - match: Host(`api.govconnect.my.id`) && PathPrefix(`/api/notifications`)
      kind: Rule
      priority: 50
      middlewares:
        - name: rate-limit-internal
        - name: cors-dashboard
        - name: security-headers
        - name: strip-api-notifications
        - name: retry-middleware
      services:
        - name: notification-service
          port: 3004

    # ==================== HEALTH ENDPOINTS ====================
    - match: Host(`api.govconnect.my.id`) && Path(`/health`)
      kind: Rule
      priority: 200
      services:
        - name: channel-service
          port: 3001

    - match: Host(`api.govconnect.my.id`) && Path(`/health/channel`)
      kind: Rule
      priority: 200
      services:
        - name: channel-service
          port: 3001

    - match: Host(`api.govconnect.my.id`) && Path(`/health/ai`)
      kind: Rule
      priority: 200
      services:
        - name: ai-service
          port: 3002

    - match: Host(`api.govconnect.my.id`) && Path(`/health/cases`)
      kind: Rule
      priority: 200
      services:
        - name: case-service
          port: 3003

    - match: Host(`api.govconnect.my.id`) && Path(`/health/notifications`)
      kind: Rule
      priority: 200
      services:
        - name: notification-service
          port: 3004

  # TLS Configuration - uncomment after cert-manager setup
  # tls:
  #   secretName: govconnect-api-tls

---
# ==================== TLS STORE (for cert-manager) ====================
# Uncomment when using cert-manager
# apiVersion: traefik.io/v1alpha1
# kind: TLSStore
# metadata:
#   name: default
#   namespace: govconnect
# spec:
#   defaultCertificate:
#     secretName: govconnect-tls
