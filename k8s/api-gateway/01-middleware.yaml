# ==================== TRAEFIK MIDDLEWARE ====================
# Rate limiting, security headers, CORS, retry, circuit breaker

---
# Rate Limiting - Public Endpoints (Webhook)
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: rate-limit-public
  namespace: govconnect
  labels:
    app.kubernetes.io/name: govconnect
    app.kubernetes.io/component: middleware
spec:
  rateLimit:
    average: 100          # 100 requests per second
    burst: 200            # Allow burst up to 200
    period: 1s
    sourceCriterion:
      ipStrategy:
        depth: 1          # Use first X-Forwarded-For IP

---
# Rate Limiting - Internal APIs (higher limit)
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: rate-limit-internal
  namespace: govconnect
  labels:
    app.kubernetes.io/name: govconnect
    app.kubernetes.io/component: middleware
spec:
  rateLimit:
    average: 500
    burst: 1000
    period: 1s
    sourceCriterion:
      ipStrategy:
        depth: 1

---
# Rate Limiting - AI Service (lower limit due to cost)
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: rate-limit-ai
  namespace: govconnect
  labels:
    app.kubernetes.io/name: govconnect
    app.kubernetes.io/component: middleware
spec:
  rateLimit:
    average: 30
    burst: 50
    period: 1s

---
# Security Headers
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: security-headers
  namespace: govconnect
  labels:
    app.kubernetes.io/name: govconnect
    app.kubernetes.io/component: middleware
spec:
  headers:
    frameDeny: true
    browserXssFilter: true
    contentTypeNosniff: true
    referrerPolicy: "strict-origin-when-cross-origin"
    stsSeconds: 63072000
    stsIncludeSubdomains: true
    stsPreload: true
    customResponseHeaders:
      X-Powered-By: "GovConnect"
      Server: ""

---
# CORS Middleware - Dashboard
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: cors-dashboard
  namespace: govconnect
  labels:
    app.kubernetes.io/name: govconnect
    app.kubernetes.io/component: middleware
spec:
  headers:
    accessControlAllowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
    accessControlAllowHeaders:
      - Content-Type
      - Authorization
      - X-Internal-API-Key
      - X-Request-Id
    accessControlAllowOriginList:
      - "https://govconnect.my.id"
      - "http://localhost:3000"
    accessControlAllowCredentials: true
    accessControlMaxAge: 86400
    addVaryHeader: true

---
# CORS Middleware - Webhook (allow all origins for WhatsApp)
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: cors-webhook
  namespace: govconnect
  labels:
    app.kubernetes.io/name: govconnect
    app.kubernetes.io/component: middleware
spec:
  headers:
    accessControlAllowMethods:
      - GET
      - POST
      - OPTIONS
    accessControlAllowHeaders:
      - Content-Type
      - X-Hub-Signature
      - X-Hub-Signature-256
    accessControlAllowOriginList:
      - "*"
    accessControlMaxAge: 86400

---
# Retry Middleware (for resilience)
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: retry-middleware
  namespace: govconnect
  labels:
    app.kubernetes.io/name: govconnect
    app.kubernetes.io/component: middleware
spec:
  retry:
    attempts: 3
    initialInterval: 100ms

---
# Circuit Breaker Middleware
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: circuit-breaker
  namespace: govconnect
  labels:
    app.kubernetes.io/name: govconnect
    app.kubernetes.io/component: middleware
spec:
  circuitBreaker:
    expression: NetworkErrorRatio() > 0.30 || ResponseCodeRatio(500, 600, 0, 600) > 0.25
    checkPeriod: 10s
    fallbackDuration: 30s
    recoveryDuration: 60s

---
# Compress Middleware (gzip)
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: compress
  namespace: govconnect
  labels:
    app.kubernetes.io/name: govconnect
    app.kubernetes.io/component: middleware
spec:
  compress:
    excludedContentTypes:
      - text/event-stream

---
# Strip Prefix - Channel Service
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: strip-api-channel
  namespace: govconnect
spec:
  stripPrefix:
    prefixes:
      - /api/channel

---
# Strip Prefix - Case Service
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: strip-api-cases
  namespace: govconnect
spec:
  stripPrefix:
    prefixes:
      - /api/cases

---
# Strip Prefix - AI Service
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: strip-api-ai
  namespace: govconnect
spec:
  stripPrefix:
    prefixes:
      - /api/ai

---
# Strip Prefix - Notification Service
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: strip-api-notifications
  namespace: govconnect
spec:
  stripPrefix:
    prefixes:
      - /api/notifications

---
# Dashboard Basic Auth (for Traefik Dashboard)
# Generate with: htpasswd -nb admin password | base64
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: dashboard-auth
  namespace: traefik
spec:
  basicAuth:
    secret: traefik-dashboard-auth

---
# Request ID Header
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: request-id
  namespace: govconnect
spec:
  headers:
    customRequestHeaders:
      X-Request-Id: "{{uuid}}"
