generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Complaint {
  id           String   @id @default(cuid())
  complaint_id String   @unique
  wa_user_id   String
  kategori     String   // jalan_rusak, lampu_mati, sampah, drainase, pohon_tumbang, fasilitas_rusak
  deskripsi    String   @db.Text
  alamat       String?
  rt_rw        String?
  foto_url     String?
  status       String   @default("baru") // baru, proses, selesai, ditolak
  admin_notes  String?  @db.Text
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt
  
  @@index([wa_user_id])
  @@index([status])
  @@index([kategori])
  @@index([created_at])
  @@index([rt_rw])
  @@map("complaints")
}

// ==================== LAYANAN PEMERINTAHAN ====================
// Daftar layanan tetap yang bisa diaktifkan/nonaktifkan oleh admin

model Service {
  id                  String   @id @default(cuid())
  code                String   @unique // kode unik layanan
  name                String   // nama layanan
  description         String   @db.Text // deskripsi layanan
  category            String   // kategori: administrasi, perizinan, kependudukan, sosial
  
  // Pengaturan layanan
  is_active           Boolean  @default(true) // layanan aktif atau tidak
  is_online_available Boolean  @default(true) // bisa reservasi online atau tidak
  
  // Persyaratan dan SOP
  requirements        String[] // daftar persyaratan dokumen
  sop_steps           String[] // langkah-langkah SOP
  estimated_duration  Int      @default(30) // estimasi durasi layanan dalam menit
  
  // Jam operasional (JSON format)
  operating_hours     Json?    // {"senin": {"open": "08:00", "close": "15:00"}, ...}
  
  // Kuota harian
  daily_quota         Int      @default(20) // kuota reservasi per hari
  
  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt
  
  reservations        Reservation[]
  
  @@index([code])
  @@index([category])
  @@index([is_active])
  @@map("services")
}

// ==================== RESERVASI ====================
// Pengganti model Ticket - untuk reservasi kedatangan warga

model Reservation {
  id               String   @id @default(cuid())
  reservation_id   String   @unique // RSV-YYYYMMDD-XXX
  wa_user_id       String
  
  // Relasi ke layanan
  service_id       String
  service          Service  @relation(fields: [service_id], references: [id])
  
  // Data umum warga (pertanyaan standar)
  citizen_data     Json     // {nama, nik, alamat, no_hp, keperluan_detail}
  
  // Jadwal reservasi
  reservation_date DateTime // tanggal reservasi
  reservation_time String   // slot waktu: "08:00", "09:00", dst
  queue_number     Int      // nomor antrian hari itu
  
  // Status reservasi
  status           String   @default("pending") // pending, confirmed, arrived, completed, cancelled, no_show
  
  // Catatan
  admin_notes      String?  @db.Text
  cancel_reason    String?  @db.Text
  
  // Timestamps
  confirmed_at     DateTime?
  arrived_at       DateTime?
  completed_at     DateTime?
  cancelled_at     DateTime?
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt
  
  @@index([wa_user_id])
  @@index([service_id])
  @@index([status])
  @@index([reservation_date])
  @@index([created_at])
  @@map("reservations")
}

// ==================== LEGACY: TICKET (untuk backward compatibility) ====================
// Akan di-deprecate, data lama tetap tersimpan

model Ticket {
  id          String   @id @default(cuid())
  ticket_id   String   @unique
  wa_user_id  String
  jenis       String   // surat_keterangan, surat_pengantar, izin_keramaian
  data_json   Json     // Flexible storage for different ticket types
  status      String   @default("pending") // pending, proses, selesai, ditolak
  admin_notes String?  @db.Text
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  
  @@index([wa_user_id])
  @@index([status])
  @@index([jenis])
  @@index([created_at])
  @@map("tickets")
}
