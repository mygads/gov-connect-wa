openapi: 3.0.3
info:
  title: GovConnect API
  version: 1.0.0
  description: |
    # GovConnect API Documentation
    
    GovConnect adalah platform pelayanan pemerintah melalui WhatsApp dengan AI.
    
    ## Services
    
    | Service | Port | Description |
    |---------|------|-------------|
    | Channel Service | 3001 | WhatsApp webhook & messaging |
    | AI Service | 3002 | AI orchestration & processing |
    | Case Service | 3003 | Laporan & tiket management |
    | Notification Service | 3004 | WhatsApp notifications |
    | Dashboard | 3000 | Admin dashboard |
    
    ## Authentication
    
    - **Internal APIs**: Header `X-Internal-API-Key`
    - **Dashboard**: JWT via cookie/header
    - **Webhook**: WhatsApp verify token
    
  contact:
    name: GovConnect Team
    email: admin@govconnect.my.id
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:3001
    description: Channel Service (Development)
  - url: http://localhost:3002
    description: AI Service (Development)
  - url: http://localhost:3003
    description: Case Service (Development)
  - url: http://localhost:3004
    description: Notification Service (Development)
  - url: https://api.govconnect.my.id
    description: Production API Gateway

tags:
  - name: Webhook
    description: WhatsApp webhook endpoints
  - name: Channel
    description: Channel service internal APIs
  - name: AI
    description: AI processing endpoints
  - name: Laporan
    description: Complaint/report management
  - name: Tiket
    description: Service ticket management
  - name: Statistics
    description: Dashboard statistics
  - name: Notifications
    description: Notification management
  - name: Health
    description: Health check endpoints

paths:
  # ==================== WEBHOOK ====================
  /webhook/whatsapp:
    get:
      tags: [Webhook]
      summary: WhatsApp webhook verification
      description: Endpoint untuk verifikasi webhook WhatsApp
      parameters:
        - name: hub.mode
          in: query
          required: true
          schema:
            type: string
            enum: [subscribe]
        - name: hub.verify_token
          in: query
          required: true
          schema:
            type: string
        - name: hub.challenge
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Verification successful
          content:
            text/plain:
              schema:
                type: string
        '403':
          description: Invalid verify token

    post:
      tags: [Webhook]
      summary: Receive WhatsApp message
      description: |
        Endpoint untuk menerima pesan dari WhatsApp.
        Pesan akan diproses oleh AI dan disimpan ke database.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WhatsAppWebhookPayload'
      responses:
        '200':
          description: Webhook received
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok

  # ==================== CHANNEL INTERNAL ====================
  /internal/send:
    post:
      tags: [Channel]
      summary: Send WhatsApp message
      security:
        - InternalApiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SendMessageRequest'
      responses:
        '200':
          description: Message sent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SendMessageResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /internal/messages:
    get:
      tags: [Channel]
      summary: Get message history
      description: Mengambil history chat untuk user (FIFO 30 messages)
      security:
        - InternalApiKey: []
      parameters:
        - name: wa_user_id
          in: query
          required: true
          schema:
            type: string
          example: "6281234567890"
        - name: limit
          in: query
          schema:
            type: integer
            default: 30
            maximum: 30
      responses:
        '200':
          description: Message history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessagesResponse'

  /internal/conversations:
    get:
      tags: [Channel]
      summary: Get conversation list
      description: Daftar semua percakapan untuk Live Chat dashboard
      security:
        - InternalApiKey: []
      parameters:
        - name: is_takeover
          in: query
          schema:
            type: boolean
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Conversation list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversationsResponse'

  # ==================== LAPORAN ====================
  /laporan/create:
    post:
      tags: [Laporan]
      summary: Create new complaint
      description: Membuat laporan baru dari warga
      security:
        - InternalApiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateComplaintRequest'
      responses:
        '201':
          description: Complaint created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateComplaintResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  /laporan:
    get:
      tags: [Laporan]
      summary: Get complaints list
      security:
        - InternalApiKey: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [baru, proses, selesai, ditolak]
        - name: kategori
          in: query
          schema:
            type: string
            enum: [jalan_rusak, lampu_mati, sampah, drainase, pohon_tumbang, fasilitas_rusak]
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Complaints list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ComplaintsListResponse'

  /laporan/{id}:
    get:
      tags: [Laporan]
      summary: Get complaint detail
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Complaint detail
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Complaint'
        '404':
          $ref: '#/components/responses/NotFound'

  /laporan/{id}/status:
    patch:
      tags: [Laporan]
      summary: Update complaint status
      security:
        - InternalApiKey: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateStatusRequest'
      responses:
        '200':
          description: Status updated
        '404':
          $ref: '#/components/responses/NotFound'

  # ==================== TIKET ====================
  /tiket/create:
    post:
      tags: [Tiket]
      summary: Create new ticket
      security:
        - InternalApiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTicketRequest'
      responses:
        '201':
          description: Ticket created

  /tiket:
    get:
      tags: [Tiket]
      summary: Get tickets list
      security:
        - InternalApiKey: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, proses, selesai, ditolak]
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Tickets list

  # ==================== STATISTICS ====================
  /statistics/overview:
    get:
      tags: [Statistics]
      summary: Get dashboard statistics
      security:
        - InternalApiKey: []
      responses:
        '200':
          description: Statistics data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatisticsResponse'

  # ==================== HEALTH ====================
  /health:
    get:
      tags: [Health]
      summary: Health check
      responses:
        '200':
          description: Service healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

components:
  securitySchemes:
    InternalApiKey:
      type: apiKey
      in: header
      name: X-Internal-API-Key
      description: API Key untuk internal service calls
    
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    
    Unauthorized:
      description: Unauthorized - missing or invalid API key
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

  schemas:
    Error:
      type: object
      properties:
        error:
          type: string
          example: Bad Request
        message:
          type: string
          example: Invalid request body
        details:
          type: array
          items:
            type: object

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [ok, degraded, error]
          example: ok
        timestamp:
          type: string
          format: date-time
        uptime:
          type: number
        version:
          type: string

    WhatsAppWebhookPayload:
      type: object
      properties:
        object:
          type: string
          example: whatsapp_business_account
        entry:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              changes:
                type: array
                items:
                  type: object

    SendMessageRequest:
      type: object
      required: [wa_user_id, message]
      properties:
        wa_user_id:
          type: string
          example: "6281234567890"
        message:
          type: string
          example: "Laporan Anda sudah diterima"

    SendMessageResponse:
      type: object
      properties:
        status:
          type: string
          enum: [sent, failed]
        message_id:
          type: string
        error:
          type: string

    Message:
      type: object
      properties:
        id:
          type: string
        wa_user_id:
          type: string
        message_text:
          type: string
        direction:
          type: string
          enum: [IN, OUT]
        source:
          type: string
          enum: [WA_WEBHOOK, AI, SYSTEM, ADMIN]
        timestamp:
          type: string
          format: date-time

    MessagesResponse:
      type: object
      properties:
        messages:
          type: array
          items:
            $ref: '#/components/schemas/Message'
        total:
          type: integer

    Conversation:
      type: object
      properties:
        wa_user_id:
          type: string
        user_name:
          type: string
        last_message:
          type: string
        last_message_at:
          type: string
          format: date-time
        unread_count:
          type: integer
        is_takeover:
          type: boolean

    ConversationsResponse:
      type: object
      properties:
        conversations:
          type: array
          items:
            $ref: '#/components/schemas/Conversation'
        total:
          type: integer

    Complaint:
      type: object
      properties:
        id:
          type: string
        complaint_id:
          type: string
          example: LAP-20251203-001
        wa_user_id:
          type: string
        kategori:
          type: string
          enum: [jalan_rusak, lampu_mati, sampah, drainase, pohon_tumbang, fasilitas_rusak]
        deskripsi:
          type: string
        alamat:
          type: string
        rt_rw:
          type: string
        foto_url:
          type: string
        status:
          type: string
          enum: [baru, proses, selesai, ditolak]
        admin_notes:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateComplaintRequest:
      type: object
      required: [wa_user_id, kategori, deskripsi]
      properties:
        wa_user_id:
          type: string
          example: "6281234567890"
        kategori:
          type: string
          enum: [jalan_rusak, lampu_mati, sampah, drainase, pohon_tumbang, fasilitas_rusak]
        deskripsi:
          type: string
          minLength: 10
        alamat:
          type: string
        rt_rw:
          type: string
        foto_url:
          type: string

    CreateComplaintResponse:
      type: object
      properties:
        status:
          type: string
          example: success
        data:
          type: object
          properties:
            complaint_id:
              type: string
            status:
              type: string

    ComplaintsListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Complaint'
        pagination:
          $ref: '#/components/schemas/Pagination'

    UpdateStatusRequest:
      type: object
      required: [status]
      properties:
        status:
          type: string
          enum: [baru, proses, selesai, ditolak]
        admin_notes:
          type: string

    Ticket:
      type: object
      properties:
        id:
          type: string
        ticket_id:
          type: string
          example: TKT-20251203-001
        wa_user_id:
          type: string
        jenis:
          type: string
          enum: [surat_keterangan, surat_pengantar, izin_keramaian]
        data_json:
          type: object
        status:
          type: string
          enum: [pending, proses, selesai, ditolak]
        created_at:
          type: string
          format: date-time

    CreateTicketRequest:
      type: object
      required: [wa_user_id, jenis, data_json]
      properties:
        wa_user_id:
          type: string
        jenis:
          type: string
          enum: [surat_keterangan, surat_pengantar, izin_keramaian]
        data_json:
          type: object

    StatisticsResponse:
      type: object
      properties:
        totalLaporan:
          type: integer
        totalTiket:
          type: integer
        laporan:
          type: object
          properties:
            baru:
              type: integer
            proses:
              type: integer
            selesai:
              type: integer
            ditolak:
              type: integer
            hariIni:
              type: integer
        tiket:
          type: object
          properties:
            pending:
              type: integer
            proses:
              type: integer
            selesai:
              type: integer
            ditolak:
              type: integer
            hariIni:
              type: integer

    Pagination:
      type: object
      properties:
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer
